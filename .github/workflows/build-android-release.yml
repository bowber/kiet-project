name: Build Android APK Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.3, etc.

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('mobile-app/Dockerfile.android') }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Docker image for Android
        run: |
          cd mobile-app
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t ocpp-android-builder \
            -f Dockerfile.android .
      
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Build Android APK using Docker
        run: |
          cd mobile-app
          docker run --rm -v "$(pwd):/app" ocpp-android-builder
          
          # Copy APK to mobile-app directory
          docker run --rm -v "$(pwd):/app" ocpp-android-builder \
            cp gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk \
            /app/ocpp-mobile-client.apk
      
      - name: Sign APK with apksigner (v2/v3)
        run: |
          cd mobile-app
          
          # Create keystore if it doesn't exist
          if [ ! -f ocpp-signing-key.keystore ]; then
            keytool -genkey -v \
              -keystore ocpp-signing-key.keystore \
              -alias ocpp-mobile \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=OCPP Mobile, OU=Development, O=OCPP, L=Unknown, ST=Unknown, C=VN"
          fi
          
          # Align APK
          docker run --rm -v "$(pwd):/app" ocpp-android-builder \
            /opt/android-sdk/build-tools/33.0.0/zipalign -v -p 4 \
            ocpp-mobile-client.apk \
            ocpp-mobile-client-aligned.apk
          
          # Sign APK
          docker run --rm -v "$(pwd):/app" ocpp-android-builder \
            /opt/android-sdk/build-tools/33.0.0/apksigner sign \
            --ks ocpp-signing-key.keystore \
            --ks-key-alias ocpp-mobile \
            --ks-pass pass:android \
            --key-pass pass:android \
            --out ocpp-mobile-client-signed.apk \
            ocpp-mobile-client-aligned.apk
          
          # Verify signature
          docker run --rm -v "$(pwd):/app" ocpp-android-builder \
            /opt/android-sdk/build-tools/33.0.0/apksigner verify \
            --verbose ocpp-mobile-client-signed.apk
          
          # Clean up and rename to final name
          rm -f ocpp-mobile-client-aligned.apk
          mv ocpp-mobile-client-signed.apk ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
      
      - name: Calculate APK checksum
        id: checksum
        run: |
          cd mobile-app
          sha256sum ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk > checksums.txt
          echo "SHA256: $(cat checksums.txt)" >> $GITHUB_STEP_SUMMARY
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          body: |
            ## OCPP Mobile Client ${{ steps.version.outputs.VERSION }}
            
            ### ðŸ“± Android APK
            
            **Installation Instructions:**
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Transfer the APK to your device and install
            4. Grant camera and network permissions when prompted
            
            **Features:**
            - OCPP 1.6 charge point simulation
            - QR code scanning for quick connection
            - Real-time WebSocket communication
            - Customer interface for charge point control
            
            **Requirements:**
            - Android 7.0 (API level 24) or higher
            - Camera permission for QR scanning
            - Network permission for WebSocket connection
            
            **Note:** This APK is signed with a development certificate. You may see an "Unknown source" warning during installation (this is normal for non-Play Store apps).
            
            ### ðŸ“‹ Checksums
            See `checksums.txt` for SHA256 verification.
            
            ---
            
            **Full Changelog:** https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}...HEAD
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocpp-mobile-client-${{ steps.version.outputs.VERSION }}
          path: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          retention-days: 90
