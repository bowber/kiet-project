name: Build Android APK Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.3, etc.

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Remove unnecessary packages and files
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker system prune -af
          sudo apt-get clean
          
          echo "=== Disk space after cleanup ==="
          df -h
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build Docker image for Android
        run: |
          cd mobile-app
          docker build -t ocpp-android-builder -f Dockerfile.android .
          
          echo "=== Disk space after Docker build ==="
          df -h
          
          # Clean up dangling images
          docker image prune -f
      
      - name: Build Android APK using Docker
        run: |
          cd mobile-app
          
          # Run build and extract APK in one step to save space
          docker run --rm -v "$(pwd):/app" ocpp-android-builder sh -c "\
            cargo tauri android init && \
            cargo tauri android build && \
            cp gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk /app/ocpp-mobile-client.apk && \
            echo 'âœ… APK copied to /app/ocpp-mobile-client.apk'"
          
          # Verify APK was created
          ls -lh ocpp-mobile-client.apk
      
      - name: Sign APK with apksigner (v2/v3)
        run: |
          cd mobile-app
          
          # Generate keystore inside Docker (has Java already)
          docker run --rm -v "$(pwd):/app" ocpp-android-builder sh -c "\
            keytool -genkey -v \
              -keystore /app/ocpp-signing-key.keystore \
              -alias ocpp-mobile \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname 'CN=OCPP Mobile, OU=Development, O=OCPP, L=Unknown, ST=Unknown, C=VN'"
          
          # Align, sign, and verify in one Docker run to save overhead
          docker run --rm -v "$(pwd):/app" ocpp-android-builder sh -c "\
            /opt/android-sdk/build-tools/33.0.0/zipalign -v -p 4 \
              /app/ocpp-mobile-client.apk \
              /app/ocpp-mobile-client-aligned.apk && \
            /opt/android-sdk/build-tools/33.0.0/apksigner sign \
              --ks /app/ocpp-signing-key.keystore \
              --ks-key-alias ocpp-mobile \
              --ks-pass pass:android \
              --key-pass pass:android \
              --out /app/ocpp-mobile-client-signed.apk \
              /app/ocpp-mobile-client-aligned.apk && \
            /opt/android-sdk/build-tools/33.0.0/apksigner verify \
              --verbose /app/ocpp-mobile-client-signed.apk && \
            echo 'âœ… APK signed and verified successfully'"
          
          # Clean up intermediate files
          rm -f ocpp-mobile-client.apk ocpp-mobile-client-aligned.apk ocpp-signing-key.keystore
          
          # Rename to versioned filename
          mv ocpp-mobile-client-signed.apk ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
          
          echo "=== Final APK ==="
          ls -lh ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
      
      - name: Calculate APK checksum
        id: checksum
        run: |
          cd mobile-app
          sha256sum ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk > checksums.txt
          echo "SHA256: $(cat checksums.txt)" >> $GITHUB_STEP_SUMMARY
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          body: |
            ## OCPP Mobile Client ${{ steps.version.outputs.VERSION }}
            
            ### ðŸ“± Android APK
            
            **Installation Instructions:**
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Transfer the APK to your device and install
            4. Grant camera and network permissions when prompted
            
            **Features:**
            - OCPP 1.6 charge point simulation
            - QR code scanning for quick connection
            - Real-time WebSocket communication
            - Customer interface for charge point control
            
            **Requirements:**
            - Android 7.0 (API level 24) or higher
            - Camera permission for QR scanning
            - Network permission for WebSocket connection
            
            **Note:** This APK is signed with a development certificate. You may see an "Unknown source" warning during installation (this is normal for non-Play Store apps).
            
            ### ðŸ“‹ Checksums
            See `checksums.txt` for SHA256 verification.
            
            ---
            
            **Full Changelog:** https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}...HEAD
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocpp-mobile-client-${{ steps.version.outputs.VERSION }}
          path: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          retention-days: 90
