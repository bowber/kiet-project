name: Build Android APK Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.3, etc.

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('mobile-app/Dockerfile.android') }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      
      - name: Build Docker image for Android
        run: |
          cd mobile-app
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t ocpp-android-builder \
            -f Dockerfile.android .
      
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
      
      - name: Build Android APK using Docker
        run: |
          cd mobile-app
          docker run --rm -v "$(pwd):/app" ocpp-android-builder
      
      - name: Rename APK with version
        run: |
          cp mobile-app/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk \
             mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
      
      - name: Calculate APK checksum
        id: checksum
        run: |
          cd mobile-app
          sha256sum ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk > checksums.txt
          echo "SHA256: $(cat checksums.txt)" >> $GITHUB_STEP_SUMMARY
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          body: |
            ## OCPP Mobile Client ${{ steps.version.outputs.VERSION }}
            
            ### ðŸ“± Android APK
            
            **Installation Instructions:**
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Transfer the APK to your device and install
            4. Grant camera and network permissions when prompted
            
            **Features:**
            - OCPP 1.6 charge point simulation
            - QR code scanning for quick connection
            - Real-time WebSocket communication
            - Customer interface for charge point control
            
            **Requirements:**
            - Android 7.0 (API level 24) or higher
            - Camera permission for QR scanning
            - Network permission for WebSocket connection
            
            **Note:** This is an unsigned APK for testing purposes. You may see a security warning during installation.
            
            ### ðŸ“‹ Checksums
            See `checksums.txt` for SHA256 verification.
            
            ---
            
            **Full Changelog:** https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}...HEAD
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocpp-mobile-client-${{ steps.version.outputs.VERSION }}
          path: |
            mobile-app/ocpp-mobile-client-${{ steps.version.outputs.VERSION }}.apk
            mobile-app/checksums.txt
          retention-days: 90
